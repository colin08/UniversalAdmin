
@{
    ViewBag.Title = "医生个人中心";
}

<!-- 头部Style等 -->
@section htmlhead{
    <link href="~/Assets/mui/css/mui.ext.loading.css" rel="stylesheet" />
    <style>
        .mui-table-view { margin-top: 20px; }

        .head-img { width: 90px; height: 90px; }

        .user-info { margin-left: 100px; }

        .user-nickname { height: 32px; display: flex; justify-content: flex-start; align-items: center; }

            .user-nickname span {margin-right:10px; overflow: hidden; text-overflow: ellipsis; }

            .user-nickname img { width: 40px; height: 32px; }

        .user-qb { height: 50px; margin-top: 4px; }

            .user-qb p { width: 150px; }
    </style>

}
<!-- 头部Style等 END -->
<!-- MUI 头部导航栏设置 -->
@section muiheader{

    <div class="mui-navbar-inner mui-bar mui-bar-nav">
        <!--
        <button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
                <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        -->
        <h1 class="mui-center mui-title">医生信息</h1>
    </div>
}
<!-- MUI 头部导航栏设置 END -->
<!-- Body -->

<ul class="mui-table-view">
    <li class="mui-table-view-cell">
        <img class="mui-pull-left head-img" onclick="selectImg()" id="head-img" src="@WorkContext.UserInfo.GetAvatar">
        <input type="file" id="hid_file_con" accept="image/jpeg,image/jpg,image/png" style="display:none;" />
        <div class="user-info">
            <div class="user-nickname" onclick="location.href='Info'">
                <span>@WorkContext.UserInfo.RealName</span>
                <label>@ViewData["TouXian"]</label>
            </div>
            <div class="user-qb">
                <p class='mui-ellipsis' id="jiesuan">可结算金额：@ViewData["KJS"] 元 </p>
            </div>
        </div>

    </li>
</ul>
<ul class="mui-table-view mui-table-view-chevron">
    <li class="mui-table-view-cell">
        <a href="Info" class="mui-navigate-right">我的资料</a>
    </li>
</ul>
<ul class="mui-table-view mui-table-view-chevron">
    <li class="mui-table-view-cell">
        <a href="Reservation" class="mui-navigate-right">预约列表</a>
    </li>
    <li class="mui-table-view-cell">
        <a href="ReservationSetting" class="mui-navigate-right">预约设置</a>
    </li>
</ul>
<ul class="mui-table-view mui-table-view-chevron">
    <li class="mui-table-view-cell">
        <a onclick="javascript:location.href='Advisory'" class="mui-navigate-right">
            用户咨询
            <span class="mui-pull-right" id="span_price">￥@ViewData["AdvisoryPrice"]/次</span>
            <input type="hidden" value="@ViewData["AdvisoryPrice"]" id="hid_zx_price" />
        </a>
    </li>
    <li class="mui-table-view-cell">
        <a>
            接受在线咨询
            <div class="mui-switch mui-switch-blue @ViewData["AdvisoryStatus"]" id="mySwitch">
                <div class="mui-switch-handle"></div>
            </div>
        </a>
    </li>
</ul>

<!-- Body END -->
<!-- MUI 底部导航栏设置 -->
@section muifooter{
    <div class="mui-bar-footer mui-text-center" style="position: fixed; width: 100%;">
        <p>@Html.Partial("~/Areas/MP/Views/Shared/_Copyright.cshtml")</p>
    </div>
}
<!-- MUI 底部导航栏设置 END -->
<!-- MUI 页面底部脚本 -->
@section htmlfoot{
    <script src="~/Assets/mui/js/jquery.min.js"></script>
    <script src="~/Assets/mui/js/mui.min.js"></script>
    <script src="~/Assets/mui/js/mui.ext.loading.js"></script>
    <script>
        document.getElementById("mySwitch").addEventListener("toggle", function (event) {
            var status = 0;
            var statusmsg = "关闭在线咨询";
            if (event.detail.isActive) {
                status = 1;
                statusmsg = "接收在线咨询";
            }
            
            mui.ajax('/mp/Doctors/ModifyAdvisoryStatus', {
                data: {
                    status: status
                },
                dataType: 'json',
                type: 'post',
                timeout: 10000,
                headers: { 'Content-Type': 'application/json' },
                success: function (data) {
                    if (data.msg == 1) {
                        mui.toast("修改为:" + statusmsg);
                    } else {
                        mui.toast("操作失败:" + data.msgbox);
                        window.setTimeout(function () {
                            location.reload();
                        }, 1000);
                    }
                },
                error: function (xhr, type, errorThrown) {
                    mui.alert('网络异常', "请检查联网是否通畅", function () {
                        location.reload();
                    });                    
                }
            });
        })

        $("#span_price").on('click', function (event) {
            event.stopPropagation();
            var default_price = $("#hid_zx_price").val();
            mui.prompt('', default_price, '修改咨询单价', ['取消', '保存'], function (e) {
                if (e.index == 1) {
                    var priceval = e.value;
                    //var temp = parseFloat(e.value);
                    //console.log(temp);
                    //return;
                    mui.showLoading("修改中..", "div");
                    mui.ajax('/mp/Doctors/ModifyAdvisoryPrice', {
                        data: {
                            price: priceval
                        },
                        dataType: 'json',
                        type: 'post',
                        timeout: 10000,
                        headers: { 'Content-Type': 'application/json' },
                        success: function (data) {
                            mui.hideLoading();
                            if (data.msg == 1) {
                                mui.toast("修改成功");
                                $("#span_price").text("￥" + priceval + "/次");
                                $("#hid_zx_price").val(priceval);
                            } else {
                                mui.alert('错误消息', data.msgbox);
                            }
                        },
                        error: function (xhr, type, errorThrown) {
                            //异常处理；
                            mui.alert('网络异常', "请检查联网是否通畅");
                        }
                    });
                } else {
                    console.log("取消设置价格");
                }
            }, 'div')
            document.querySelector('.mui-popup-input input').type = 'number';
        });

        $("#jiesuan").on('click', function (event) {
            event.stopPropagation();
            location.href = "AdvisoryClear";
        });


        function selectImg() {
            $("#hid_file_con").click();
        }

        $("#hid_file_con").on("change", function () {
            var filePath = $(this).val().toLowerCase();
            if (filePath.indexOf("jpg") != -1 || filePath.indexOf("png") != -1 || filePath.indexOf("jpeg") != -1) {
                var arr = filePath.split('\\');
                var fileName = arr[arr.length - 1];
                upload();
            } else {
                mui.toast("选择的图片格式有误");
                return false
            }
        })

        function upload() {
            mui.showLoading("上传头像中..", "div");
            var fd = new FormData();
            fd.append("FileData", document.getElementById('hid_file_con').files[0]);

            $.ajax({
                url: '/MP/Tools/UploadAvatar',
                type: 'POST',
                cache: false,
                contentType: "multipart/form-data",
                data: fd,
                processData: false,
                contentType: false
            }).done(function (res) {
                mui.hideLoading();
                if (res.msg == 1) {
                    $("#head-img").attr("src", res.data);
                } else {
                    alert(res.msgbox);
                }
            }).fail(function (res) {
                mui.alert("发生错误", "请稍后重试");
            });
        }

    </script>
}
<!-- MUI 页面底部脚本 END -->
