@model Universal.Entity.ViewModel.ConsultationDetail
@{
    ViewBag.Title = "医生个人中心";
}

<!-- 头部Style等 -->
@section htmlhead{
    <link href="~/Assets/mui/css/swiper-4.2.0.min.css" rel="stylesheet" />
    <style>
        .bbs-msg-left { display: flex; justify-content: center; flex-direction: row; }

        .bbs-msg-left-headimg { width: 80px; height: 80px; }

        .bbs-msg-left-content { margin-left: 10px; }
            .bbs-msg-left-content p { font-size: 16px !important; }

        .bbs-msg-left-album { margin: 1em 0; height: 50px; overflow: hidden; }

            .bbs-msg-left-album img { width: 60px; float: left; margin-right: 10px; display: block; }

        .msg-time span{color:rgba(0,0,0,0.4);font-size:10px;}

        #origin-img { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; }

            #origin-img .swiper-slide img { width: 100%; vertical-align: middle; }

        .swiper-pagination { top: 6em; bottom: auto; color: #fff; }
        audio{width:98%;}
    </style>
}
<!-- 头部Style等 END -->
<!-- MUI 头部导航栏设置 -->
@section muiheader{
    <div class="mui-navbar-inner mui-bar mui-bar-nav">
        <button type="button" id="btn_back" onclick="javascript:location.href='Advisory'" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        <h1 id="h_title" class="mui-center mui-title">用户咨询详情</h1>
    </div>

}
<!-- MUI 头部导航栏设置 END -->
<!-- Body -->
@{ 
    System.Text.StringBuilder str_img_data = new System.Text.StringBuilder();
}
<div class="mui-content-padded">
    <ul class="mui-table-view">
        @foreach (var msg in Model.msg_list)
        {
            if (msg.user_type == Universal.Entity.ReplayUserType.User)
            {
                <li class="mui-table-view-cell">
                    <div class="bbs-msg-left">
                        <img class="bbs-msg-left-headimg" src="@Model.user_avatar" />
                        <div class="bbs-msg-left-content">
                            @if (msg.total_voice > 0)
                            {
                                <div class="bbs-msg-left-message">
                                    <audio controls="controls">
                                        @foreach (var voice in msg.file_voice_list)
                                        {
                                            <source src="@voice" type="audio/mpeg">
                                        }
                                    </audio>
                                </div>
                            }
                            <div class="bbs-msg-left-text">
                                <p>@msg.content</p>
                            </div>
                            @{ 
                                str_img_data.Append("\"list" + msg.id.ToString() + "\":[");
                            }
                            <div class="bbs-msg-left-album" thumblist="list@(msg.id)">
                                @foreach (var file_path in msg.file_image_list)
                                {
                                    str_img_data.Append("\""+file_path+"\",");
                                    <img src="@file_path" />
                                }

                                 @{ 
                                    if (msg.file_image_list.Count > 0)
                                    {
                                        str_img_data.Remove(str_img_data.Length - 1, 1);
                                    }
                                    str_img_data.Append("],");
                                 }
                            </div>
                        </div>
                    </div>
                    <div class="mui-text-center">
                        <p class="msg-time">@msg.time_str <span>(@msg.time.ToString("MM-dd HH:mm"))</span></p>
                    </div>
                </li>
            }
            else
            {
                <li class="mui-table-view-cell">
                    <div class="bbs-msg-left">                        
                        <div class="bbs-msg-left-content">
                            @if(msg.total_voice > 0)
                            {
                                <div class="bbs-msg-left-message">
                                    <audio controls="controls">
                                        @foreach (var voice in msg.file_voice_list)
                                        {
                                            <source src="@voice" type="audio/mpeg">
                                        }
                                    </audio>
                                </div>
                            }
                            <div class="bbs-msg-left-text">
                                <p>@msg.content</p>
                            </div>
                            
                             @{ 
                                str_img_data.Append("\"list" + msg.id.ToString() + "\":[");
                            }

                            <div class="bbs-msg-left-album" thumblist="list@(msg.id)">
                                @foreach (var file_path in msg.file_image_list)
                                {
                                    str_img_data.Append("\""+file_path+"\",");
                                    <img src="@file_path" />
                                }
                               

                                @{ 
                                    if (msg.file_image_list.Count > 0)
                                    {
                                        str_img_data.Remove(str_img_data.Length - 1, 1);
                                    }
                                    str_img_data.Append("],");
                                 }

                            </div>
                        </div>
                    <img class="bbs-msg-left-headimg" src="@Model.doctor_avatar" />
                    </div>
                    <div class="mui-text-center">
                        <p class="msg-time">@msg.time_str <span>(@msg.time.ToString("MM-dd HH:mm"))</span></p>
                    </div>
                </li>
            }

        }

    </ul>

    <button type="button" onclick="alert('功能正在开发')" class="mui-btn mui-btn-primary mui-btn-block" style="margin-top: 20px;">回复</button>

</div>

<!-- Body END -->
<!-- MUI 底部导航栏设置 -->
@section muifooter{
    <div class="mui-bar-footer mui-text-center" style="width: 100%;">
        <p>@Html.Partial("~/Areas/MP/Views/Shared/_Copyright.cshtml")</p>
    </div>


    <div class="swiper-container" id="origin-img">
        <div class="swiper-wrapper"></div>
        <div class="swiper-pagination"></div>
    </div>
}
<!-- MUI 底部导航栏设置 END -->
<!-- MUI 页面底部脚本 -->
@section htmlfoot{
    <script src="~/Assets/mui/js/jquery.min.js"></script>
    <script src="~/Assets/mui/js/swiper-4.2.0.min.js"></script>

    <script>
        var swiperStatus = false;
        imgsdata = @Html.Raw("{" + str_img_data.ToString() + "}")
            
        var swiper = new Swiper('.swiper-container', {
            zoom: true,
            width: window.innerWidth,
            virtual: true,
            spaceBetween: 20,
            pagination: {
                el: '.swiper-pagination',
                type: 'fraction',
            },
            on: {
                click: function () {
                    $('#origin-img').fadeOut('fast');
                    this.virtual.slides.length = 0;
                    this.virtual.cache = [];
                    swiperStatus = false;
                    $("#btn_back").show();
                    $("#h_title").text("用户咨询详情");
                },
            },

        });

        $('.bbs-msg-left-album img').click(function () {
            clickIndex = $(this).index();

            imglist = $(this).parent().attr('thumblist');
            imgs = imgsdata[imglist];
            for (i = 0; i < imgs.length; i++) {
                swiper.virtual.appendSlide('<div class="swiper-zoom-container"><img src="' + imgs[i] + '" /></div>');
            }
            swiper.slideTo(clickIndex);
            $('#origin-img').fadeIn('fast');
            swiperStatus = true;
            $("#btn_back").hide();
            $("#h_title").text("图片浏览");
        })

        //切换图状态禁止页面缩放
        document.addEventListener('touchstart', function (event) {
            if (event.touches.length > 1 && swiperStatus) {
                event.preventDefault();
            }
        })
        var lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false)

        document.addEventListener('touchmove', function (e) {
            if (swiperStatus) {
                e.preventDefault();
            }
        })
    </script>

}
<!-- MUI 页面底部脚本 END -->
