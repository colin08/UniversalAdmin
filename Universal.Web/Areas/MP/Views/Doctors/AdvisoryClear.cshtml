
@{
    ViewBag.Title = "医生个人中心";
}

<!-- 头部Style等 -->
@section htmlhead{
    <link href="~/Assets/mui/css/mui.ext.loading.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/Assets/mui/css/public.css">
    <style>

        .head-img { width: 90px !important; height: 90px; }

        .user-info { margin-left: 100px; }

        .user-nickname { height: 32px; display: flex; justify-content: flex-start; align-items: center; }

            .user-nickname span { overflow: hidden; text-overflow: ellipsis; }

            .user-nickname img { width: 40px; height: 32px; }

        .user-qb { height: 50px; margin-top: 4px; }
        .mui-control-item { width: 33% !important; }
        .ss-money { margin-left: 5px; color: #007aff; }
        .fixed-group-buttom { height: 50px; width: 100%; background: white; padding: 1px 10px; position: fixed; display: flex; z-index: 999; justify-content: space-between; align-items: center; }
        .js-price { color: #007aff; font-size: 18px; }
        .js-remark { font-size: 14px; color: rgba(0,0,0,0.7); }
    </style>
}
<!-- 头部Style等 END -->
<!-- MUI 头部导航栏设置 -->
@section muiheader{
    <div class="mui-navbar-inner mui-bar mui-bar-nav">
        <button type="button" onclick="javascript:location.href='Index'" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        <h1 class="mui-center mui-title">咨询结算</h1>
        <button type="button" onclick="location.href='AdvisoryClearHostory'" class="mui-right mui-btn  mui-btn-link mui-btn-nav mui-pull-right">
            结算历史
        </button>
    </div>

}
<!-- MUI 头部导航栏设置 END -->
<!-- Body -->

    <div class="mui-content-padded">

        <div id="slider" class="mui-slider mui-fullscreen">
            <div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
                <div class="mui-scroll slidertab">
                    <a class="mui-control-item mui-active" href="#item1mobile">
                        可结算
                    </a>
                    <a class="mui-control-item" href="#item2mobile">
                        不可结算
                    </a>
                    <a class="mui-control-item" href="#item3mobile">
                        已结算
                    </a>
                </div>
            </div>
            <div class="mui-slider-group" style="bottom:50px;">
                <div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
                    <div id="scroll1" class="mui-scroll-wrapper">
                        <div class="mui-scroll">
                            <ul class="mui-table-view" id="ul_kejiesuan" pageIndex='1' dataTotal='' data-type="1" template-id="template_kejiesuan" ajaxUrl="/MP/Doctors/GetAdvisoryClearPageList">

                                <script type="text/html" id="template_kejiesuan">
                                    {{each data}}
                                    <li class="mui-table-view-cell" data-index="{{$value.id}}">
                                        <a class="mui-navigate-right li-a" href="javascript:void(0)">
                                            <img class="mui-pull-left head-img" id="head-img" src="{{$value.avatar}}">
                                            <div class="user-info">
                                                <div class="user-nickname">
                                                    <span>{{$value.nick_name}} {{$value.gender}} {{$value.age}}岁</span>
                                                    <label class="ss-money">￥{{$value.price}}</label>
                                                    <div class="mui-input-row mui-checkbox">
                                                        <label></label>
                                                        <input name="ck-jiesuan" onchange="checkChange()" class="jiesuanck" data-id="{{$value.id}}" value="{{$value.price}}" type="checkbox" style="top: 0 !important;">
                                                    </div>
                                                </div>
                                                <div class="user-qb">
                                                    <p class='mui-ellipsis'>最后回复：{{$value.last_reply_time_str}}</p>
                                                    <p class="mui-ellipsis">
                                                        {{if $value.last_replay_user == 2}}
                                                        我说
                                                        {{else}}
                                                        Ta说
                                                        {{/if}}
                                                        :{{$value.last_reply_content}}
                                                    </p>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                {{/each}}
                                </script>

                            </ul>
                        </div>
                    </div>

                </div>
                <div id="item2mobile" class="mui-slider-item mui-control-content">
                    <div class="mui-scroll-wrapper">
                        <div class="mui-scroll">
                            <ul class="mui-table-view" id="ul_bujiesuan" pageIndex='1' dataTotal=''data-type="2" template-id="template_bujiesuan" ajaxUrl="/MP/Doctors/GetAdvisoryClearPageList">

                                <script type="text/html" id="template_bujiesuan">
                                    {{each data}}
                                    <li class="mui-table-view-cell">
                                        <a class="mui-navigate-right li-a" href="javascript:void(0)">
                                            <img class="mui-pull-left head-img" id="head-img" src="{{$value.avatar}}">
                                            <div class="user-info">
                                                <div class="user-nickname">
                                                    <span>{{$value.nick_name}} {{$value.gender}} {{$value.age}}岁 {{$value.disease}}</span>
                                                
                                                </div>
                                                <div class="user-qb">
                                                    <p class='mui-ellipsis'>最后回复：{{$value.last_reply_time_str}}</p>
                                                    <p class="mui-ellipsis">
                                                        不可结算原因:{{$value.sett_desc}}
                                                    </p>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    {{/each}}
                                </script>

                            </ul>
                        </div>
                    </div>
                </div>
                <div id="item3mobile" class="mui-slider-item mui-control-content">
                    <div class="mui-scroll-wrapper">
                        <div class="mui-scroll">
                            <ul class="mui-table-view" id="ul_yijiesuan" pageIndex='1' dataTotal='' data-type="3" template-id="template_yijiesuan" ajaxUrl="/MP/Doctors/GetAdvisoryClearPageList">

                                <script type="text/html" id="template_yijiesuan">
                                    {{each data}}
                                    <li class="mui-table-view-cell">
                                        <a class="mui-navigate-right li-a" href="javascript:void(0)">
                                            <img class="mui-pull-left head-img" id="head-img" src="{{$value.avatar}}">
                                            <div class="user-info">
                                                <div class="user-nickname">
                                                    <span>{{$value.nick_name}} {{$value.gender}} {{$value.age}}岁 {{$value.disease}}</span>
                                                
                                                </div>
                                                <div class="user-qb">
                                                    <p class='mui-ellipsis'>最后回复：{{$value.last_reply_time_str}}</p>
                                                    <p class="mui-ellipsis">
                                                        结算状态:{{$value.sett_desc}}
                                                    </p>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    {{/each}}
                                </script>

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

<!-- Body END -->
<!-- MUI 底部导航栏设置 -->
@section muifooter{
    <div class="mui-bar-footer fixed-group-buttom">
        <div class="bar-left">
            选中总额:<span class="js-price">￥0</span>&nbsp;<span class="js-remark">(0项)</span>
            <input type="hidden" id="hid-js-ids" value="" />
        </div>
        <div class="bar-right">
            <button id="btn_goto" onclick="Ajax_To_Clear()" class="mui-btn-blue">提交结算申请</button>
        </div>
    </div>

}
<!-- MUI 底部导航栏设置 END -->
<!-- MUI 页面底部脚本 -->
@section htmlfoot{
    <script src="~/Assets/mui/js/mui.min.js"></script>
    <script src="~/Assets/mui/js/jquery.min.js"></script>
    <script src="~/Assets/mui/js/mui.pullToRefresh.js"></script>
    <script src="~/Assets/mui/js/mui.pullToRefresh.material.js"></script>
    <script src="~/Assets/mui/js/mui.ext.loading.js"></script>
    <script src="~/Assets/mui/js/template-web.js"></script>

    <script>
        mui.init();

        //CheckBox选中
        function checkChange() {
            //循环获取列表
            var select_count = $('input:checkbox:checked').length;
            var total_amount = 0;
            var select_ids = "";
            $.each($('input:checkbox:checked'), function () {
                //console.log("选择了："+select_count+"个，当前选中的金额："+$(this).attr('value'));
                total_amount += parseFloat($(this).attr('value'));
                select_ids += $(this).attr('data-id') + ",";
            })
            $(".js-price").text('￥' + total_amount);
            $(".js-remark").text("(" + select_count + "项)");
            if (select_ids.length > 0) {
                select_ids = select_ids.substring(0, select_ids.length - 1);
            }
            $("#hid-js-ids").val(select_ids);

            console.log("选中的项ID：" + $("#hid-js-ids").val());

        }

        (function ($$) {
            //阻尼系数
            var deceleration = mui.os.ios ? 0.003 : 0.0009;
            var pageSize = 5;
            var count = 0;

            $$('.mui-scroll-wrapper').scroll({
                bounce: false,
                indicators: true, //是否显示滚动条
                deceleration: deceleration
            });
            

            //滑动数据初始化
            document.querySelector('.mui-slider').addEventListener('slide', function (event) {
                var ul = $('.mui-slider').find('.mui-slider-group').find('.mui-slider-item').eq(event.detail.slideNumber).find('.mui-table-view');
                var pageIndex = ul.attr('pageIndex');
                if (pageIndex == '1') {
                    var template_id = ul.attr('template-id');
                    var ajaxUrl = ul.attr('ajaxUrl');
                    var ul_id = ul.attr('id');
                    var d_type = ul.attr('data-type');
                    var params_data = { "page_size": pageSize, "page_index": parseInt(pageIndex), "type": d_type };
                    Ajax_Load_Pullrefresh_Data(true, ajaxUrl, params_data, ul_id, template_id, pageIndex, pageSize);
                }
                if (ul.attr('id') == 'ul_kejiesuan') {
                    $(".fixed-group-buttom").show();
                    $(".mui-slider-group").css("bottom", 50);
                } else {
                    $(".fixed-group-buttom").hide();
                    $(".mui-slider-group").css("bottom", 0);
                }
            });
            $$.ready(function () {
                //循环初始化所有下拉刷新，上拉加载。
                $$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function (index, pullRefreshEl) {
                    //加载第一个数据
                    if (index == '0') {
                        var ul = this.querySelector('.mui-table-view');
                        var pageIndex = ul.getAttribute('pageIndex');
                        var template_id = ul.getAttribute('template-id');
                        var ul_id = ul.getAttribute('id');
                        if (pageIndex == '1') {
                            var ajaxUrl = ul.getAttribute('ajaxUrl');
                            var ul_id = ul.getAttribute('id');
                            var d_type = ul.getAttribute('data-type');
                            var params_data = { "page_size": pageSize, "page_index": parseInt(pageIndex), "type": d_type };
                            Ajax_Load_Pullrefresh_Data(true, ajaxUrl, params_data, ul_id, template_id, pageIndex, pageSize);
                        }
                    }

                    $$(pullRefreshEl).pullToRefresh({
                        down: {
                            callback: function () {
                                var self = this;
                                var ul = self.element.querySelector('.mui-table-view');
                                var pageIndex = 1;//ul.getAttribute('pageIndex');
                                var template_id = ul.getAttribute('template-id');
                                var ajaxUrl = ul.getAttribute('ajaxUrl');
                                var ul_id = ul.getAttribute('id');
                                var d_type = ul.getAttribute('data-type');
                                var params_data = { "page_size": pageSize, "page_index": parseInt(pageIndex), "type": d_type };
                                Ajax_Load_Pullrefresh_Data(true, ajaxUrl, params_data, ul_id, template_id, pageIndex, pageSize)
                                self.endPullDownToRefresh();
                                //如果之前上拉没数据了，这里重新启用上拉刷新
                                self.refresh(true);
                                

                            }
                        },
                        up: {
                            contentrefresh: '正在加载...',
                            contentnomore: '没有更多数据了',
                            callback: function () {
                                var self = this;
                                var ul = self.element.querySelector('.mui-table-view');
                                var pageIndex = ul.getAttribute('pageIndex');
                                var template_id = ul.getAttribute('template-id');
                                var ajaxUrl = ul.getAttribute('ajaxUrl');
                                var ul_id = ul.getAttribute('id');
                                var d_type = ul.getAttribute('data-type');
                                var params_data = { "page_size": pageSize, "page_index": parseInt(pageIndex), "type": d_type };
                                Ajax_Load_Pullrefresh_Data(false, ajaxUrl, params_data, ul_id, template_id, pageIndex, pageSize)
                                var data_total = ul.getAttribute('dataTotal');
                                var pullSize = data_total / pageSize;
                                var is_end = ++count > pullSize;
                                self.endPullUpToRefresh(is_end);
                                //console.log("数据量：" + data_total + ",最大页：" + pullSize + ",是否最大：" + is_end);
                            }
                        }
                    });
                });
            });
        })(mui);

        function Ajax_Load_Pullrefresh_Data(reload, url, params_data, ul_id, template_id, pageIndex, pageSize) {
            mui.showLoading('数据加载中...', 'div');
            unBindTap();
            mui.ajax({
                url: url,
                data: params_data,
                dataType: 'json', //服务器返回json格式数据
                type: 'post', //HTTP请求类型
                async: false,//同步请求
                timeout: 6000, //超时时间设置为6秒
                success: function (res) {
                    mui.hideLoading();
                    if (res.msg == 0) {
                        //提前置为0，不再上拉加载
                        $('#' + ul_id).attr('dataTotal', 0);
                        mui.alert(res.msgbox);
                        return;
                    }
                    //取返回的数据
                    var html = template(template_id, res);
                    if (reload) {
                        //覆盖数据
                        $('#' + ul_id).html(html);
                    } else {
                        //追加数据
                        $('#' + ul_id).append(html);
                    }
                    if ($('#' + ul_id) && $('#' + ul_id).attr('pageIndex') != '') {
                        $('#' + ul_id).attr('pageIndex', parseInt(pageIndex) + 1);
                    }
                    if ($('#' + ul_id)) {
                        $('#' + ul_id).attr('dataTotal', res.total)
                    }
                    bindTap();
                },
                error: function (xhr, type, errorThrown) {
                    mui.hideLoading();
                    //异常处理；
                    mui.alert("获取数据失败，请检查网络连接");
                }
            });
        };

        function Ajax_To_Clear() {
            var ids = $("#hid-js-ids").val();
            if (ids.length == 0) {
                mui.alert("请选择需要结算的咨询");
                return;
            }
            mui.showLoading('申请提交中...', 'div');
            mui.ajax({
                url: "/MP/Doctors/ToAdvisoryClear",
                data: {"ids":ids},
                dataType: 'json', //服务器返回json格式数据
                type: 'post', //HTTP请求类型
                async: false,//同步请求
                timeout: 6000, //超时时间设置为6秒
                success: function (res) {
                    mui.hideLoading();
                    mui.toast(res.msgbox);
                    if (res.msg == 1) {
                        window.setTimeout(function () {
                            location.reload();
                        }, 1000);
                    }
                },
                error: function (xhr, type, errorThrown) {
                    mui.hideLoading();
                    //异常处理；
                    mui.alert("获取数据失败，请检查网络连接");
                }
            });
        };

        //取消绑定点击事件
        function unBindTap() {
            //mui('.mui-table-view-cell').off('tap', 'a');
        }

        //绑定点击事件
        function bindTap() {
            //mui('.mui-table-view-cell').on('tap', 'a', function (e) {
            //    var data_link = this.getAttribute("data-link");
            //    if (data_link != null) {
            //        location.href = data_link;
            //    }
            //});
        }

    </script>

}
<!-- MUI 页面底部脚本 END -->
