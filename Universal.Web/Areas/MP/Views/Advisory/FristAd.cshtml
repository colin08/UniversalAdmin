@model Senparc.Weixin.MP.Helpers.JsSdkUiPackage
@{
    ViewBag.Title = "在线咨询";
}

<!-- 头部Style等 -->
@section htmlhead{
    <link href="~/Assets/mui/css/mui.picker.min.css" rel="stylesheet" />
    <link href="~/Assets/mui/css/mui.ext.loading.css" rel="stylesheet" />
    <style>
        .custom-head { padding-right: 10px !important; display: flex; justify-content: space-between; align-items: center; }
        .custom-head-doc { display: inline-flex; align-items: center; }
            .custom-head-doc img { margin-right: 10px; width: 25px; height: 25px; }
        .custom-input input, textarea { border: none; margin-bottom: 0 !important; }
        .custom-input li { display: flex; justify-content: space-around; align-items: center; }
        .custom-input label { width: 40%; }
        .custom-li-br { display: block !important; margin-top: 10px; }
        .row-ertitle { margin-left: 5px; font-size: 14px; color: rgba(0,0,0,0.6); }
        #info { color: rgba(0,0,0,0.6); }

        .upload-album { list-style: none; margin: 0; padding: 10px 0; }

            .upload-album li { float: left; margin: 5px; position: relative; width: 30%; }

                .upload-album li img { width: 100%; height: 99px; }

                .upload-album li i { display: block; width: 24px; height: 24px; background: url(/Assets/mui/img/icon-cancel.png) no-repeat; background-size: 24px 24px; position: absolute; top: 2px; right: 2px; }

        .mui-table-view-cell.mui-active { background-color: #fff !important; }
        .voice-btn-group { display: inline-block; }
    </style>

}
<!-- 头部Style等 END -->
<!-- MUI 头部导航栏设置 -->
@section muiheader{
    <div class="mui-navbar-inner mui-bar mui-bar-nav">
        <button type="button" onclick="javascript:location.href='@ViewData["BackUrl"]'" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
            <span class="mui-icon mui-icon-left-nav"></span>
        </button>
        <h1 class="mui-center mui-title">填写咨询内容</h1>
    </div>

}
<!-- MUI 头部导航栏设置 END -->
<!-- Body -->
<div class="mui-content-padded" style="margin: 10px 0;">
    <ul class="mui-table-view mui-table-view-chevron">
        <li class="mui-table-view-cell custom-head">
            <span>向TA咨询</span>
            <div class="custom-head-doc">
                <img src="@ViewData["DocAvatar"]" />
                <span>@ViewData["DocName"]</span>
            </div>
        </li>
    </ul>

    <ul class="mui-table-view custom-input" style="margin-top: 10px;">
        <li class="mui-table-view-cell">
            <label>病症类型</label>
            <input type="hidden" id="hid_ctype" value="0" />
            <input type="text" class="mui-input-clear" name="text_ctype" id="text_ctype" value="" readonly placeholder="点击选择类型" />
        </li>
        <li class="mui-table-view-cell">
            <label>所在地</label>
            <input type="text" class="mui-input-clear" name="text_local" id="text_local" value="" placeholder="请输入所在地" maxlength="6" />
        </li>
        <li class="mui-table-view-cell custom-li-br">
            <label>问题描述:</label>
            <textarea id="txt_remark" data-maxNumber="100" cols="50" rows="6" style="margin-top: 10px;" placeholder="请详细描述您的患病时间、症状、先骨干医生的诊断，药物服用情况以及您当前需要医生为您解答的问题"></textarea>
        </li>
    </ul>
    <ul class="mui-table-view" style="margin-top: 10px;">
        <li class="mui-table-view-cell">
            <label>添加录音</label><label class="row-ertitle">(录音时长不能超过1分钟)</label>
            <div class="upload-voice">                
                <div class="upload-voice-start">
					<button type="button" id="btn_voice_record" class="mui-btn-success mui-btn-outlined" style="margin:20px 5px;">按住不放即可录音</button>
				</div>

				<div class="upload-voice-play" style="display:none;">
					<button type="button" id="btn_voice_play" class="mui-btn-success mui-btn-outlined" style="margin:20px 5px;">播放录音</button>
				</div>

            </div>
        </li>
    </ul>
    <ul class="mui-table-view" style="margin-top: 10px;">
        <li class="mui-table-view-cell">
            <label>图片上传</label><label class="row-ertitle">(检查报告，症状部位等图片)</label>
            <ul class="upload-album">

                <li class="upload-album-add" onclick="chooseImage()"><img src="~/Assets/mui/img/upload-add.png" /> </li>
            </ul>

        </li>
    </ul>
</div>
<div class="mui-content-padded">
    <input type="hidden" id="hid_btn_text" value="提交并支付￥@ViewData["PriceShow"]" />
    <button type="button" id="btn_save" data-loading-text="提交中..." data-loading-icon="mui-spinner mui-spinner-custom" class="mui-btn mui-btn-primary mui-btn-block" style="margin-top: 20px;">提交并支付￥@ViewData["PriceShow"]</button>
</div>
<!-- Body END -->
<!-- MUI 底部导航栏设置 -->
@section muifooter{

}
<!-- MUI 底部导航栏设置 END -->
<!-- MUI 页面底部脚本 -->
@section htmlfoot{
    <script src="~/Assets/mui/js/jquery.min.js"></script>
    <script src="~/Assets/mui/js/mui.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="~/Assets/mui/js/mui.picker.min.js"></script>
    <script src="~/Assets/mui/js/mui.ext.loading.js"></script>
    <script src="~/Assets/mui/js/jquery.limitTextarea.js"></script>
    <script type="text/javascript">
        // 全局变量存储
        var images = {
            localIds: [],
            serverIds: []
        };
        //返回音频的本地ID  
        var VoiceLocalId="";
        //返回音频的服务器端ID  
        var VoiceServerId="";  
        //录音计时,小于指定秒数(minTime = 10)则设置用户未录音  
        var startTime, endTime, minTime = 3;  

        $(function () {
            $('#txt_remark').limitTextarea({
                maxNumber: parseInt($('#txt_remark').attr('data-maxNumber')), //最大字数
                position: 'bottom', //提示文字的位置，top：文本框上方，bottom：文本框下方
                onOk: function () {
                    $('#txt_remark').css('background-color', 'white');
                    $('#btn_save').removeClass("mui-disabled");
                    $('#btn_save').removeAttr("disabled");
                }, //输入后，字数未超出时调用的函数
                onOver: function () {
                    $('#txt_remark').css('background-color', 'lightpink');
                    $('#btn_save').addClass("mui-disabled");
                    $('#btn_save').attr('disabled', true);
                } //输入后，字数超出时调用的函数，这里把文本区域的背景变为粉红色
            });
        });


        (function ($$) {
            $$.init();
            $$("#btn_save")[0].addEventListener('tap', function () {
                var btn = this;
                
                var server_id_arr = [];
                $(".album-item").each(function () {
                    var server_id = $(this).find("img").attr("server-id");
                    if (server_id.length == 0) {
                        $$.toast("正在上传图片...");
                        return;
                    } else {
                        server_id_arr.push(server_id);
                    }
                });
                var server_ids = server_id_arr.join();

                if (VoiceLocalId.length != 0 && VoiceServerId.length == 0) {
                    $$.toast("正在上传语音...");
                    return;
                }

                var c_type_id = $("#hid_ctype").val();
                var doc_id = @ViewData["DocID"];
                var area = $("#text_local").val();
                var remark = $("#txt_remark").val();
                if (c_type_id == 0) {
                    mui.toast("请选择病症类型");
                    return;
                }
                if (area.length == 0) {
                    mui.toast("请填写所在地区");
                    return;
                }
                if (doc_id <= 0) {
                    mui.toast("非法医生");
                    return;
                }

                mui(btn).button('loading');
                mui.showLoading("保存中");

                mui.ajax('/mp/Advisory/AddFristAd', {
                    data: {
                        doc_id: doc_id,
                        c_type_id: c_type_id,
                        area: area,
                        remark: remark,
                        media_pic_ids: server_ids,
                        voice_id: VoiceServerId
                    },
                    dataType: 'json',
                    type: 'post',
                    timeout: 10000,
                    headers: { 'Content-Type': 'application/json' },
                    success: function (data) {
                        mui.hideLoading();
                        mui(btn).button('reset');
                        if (data.msg == 1) {
                            window.location.href = "/MP/Pay/OrderAdvisory?o=" + data.data;
                        } else {
                            mui.alert('错误消息', data.msgbox);
                        }
                    },
                    error: function (xhr, type, errorThrown) {
                        mui.hideLoading();
                        //异常处理；
                        mui.alert('网络异常', "请检查联网是否通畅");
                    }
                });

            })

            $$("#btn_voice_record")[0].addEventListener('touchstart', function () {
                event.preventDefault();
                document.getElementById("btn_voice_record").innerText = "正在录音";
                startTime = new Date().getTime();
                $("#txt_remark").blur();
                //开始录音  
                wx.startRecord();
            })

            $$("#btn_voice_record")[0].addEventListener('touchend', function () {
                event.preventDefault();
                document.getElementById("btn_voice_record").innerText = "按住不放即可录音";
                //停止录音接口  
                wx.stopRecord({
                    success: function (res) {
                        VoiceLocalId = res.localId;
                        endTime = new Date().getTime();
                        $$.toast("录音时长：" + (endTime - startTime) / 1000 );
                        if ((endTime - startTime) / 1000 < minTime) {
                            VoiceLocalId = '';
                            $$.toast('录音少于' + minTime + '秒，录音失败，请重新录音');
                            return;
                        }
                        if (VoiceLocalId.length > 0) {
                            CanPlayVoice();

                            //上传音频
                            uploadVoice();
                        }
                    }
                });                
            })

            //播放录音
            $$("#btn_voice_play")[0].addEventListener('tap', function () {
                var text = document.getElementById("btn_voice_play").innerText;
                if (text == "播放录音") {
                    if (VoiceLocalId.length == 0) {
                        $$.toast("您还没有录音");
                        return;
                    } else {
                        //播放语音接口  
                        wx.playVoice({
                            //需要播放的音频的本地ID，由 stopRecord 或 onVoiceRecordEnd 接口获得  
                            localId: VoiceLocalId
                        });  
                    }
                    document.getElementById("btn_voice_play").innerText = "停止播放";
                    $("#btn_voice_play").removeClass("mui-btn-success");
                    $("#btn_voice_play").addClass("mui-btn-warning");
                } else if (text == "停止播放") {
                    //停止播放接口  
                    wx.stopVoice({
                        //需要停止的音频的本地ID，由 stopRecord 或 onVoiceRecordEnd 接口获得  
                        localId: VoiceLocalId
                    });  
                    document.getElementById("btn_voice_play").innerText = "播放录音";
                    $("#btn_voice_play").removeClass("mui-btn-warning");
                    $("#btn_voice_play").addClass("mui-btn-success");
                }
            })


            $$("#text_ctype")[0].addEventListener('tap', function () {
                var picker = new mui.PopPicker();
                picker.setData(@Html.Raw(ViewData["DiseaseJson"]));
                picker.pickers[0].setSelectedValue(document.getElementById("hid_ctype").value);
                picker.show(function (selectItems) {
                    $("#text_ctype").val(selectItems[0].text);
                    $("#hid_ctype").val(selectItems[0].value);
                })
            });
        })(mui);


        wx.config({
            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId: '@Model.AppId', // 必填，公众号的唯一标识
            timestamp: '@Model.Timestamp', // 必填，生成签名的时间戳
            nonceStr: '@Model.NonceStr', // 必填，生成签名的随机串
            signature: '@Model.Signature',// 必填，签名
            jsApiList: [
                    'chooseImage',
                    'previewImage',
                    'uploadImage',
                    'startRecord', 'stopRecord', 'onVoiceRecordEnd', 'playVoice', 'stopVoice', 'onVoicePlayEnd', 'uploadVoice'
            ]
        });

        wx.ready(function () {
            //监听录音自动停止接口  
            wx.onVoiceRecordEnd({
                //录音时间超过一分钟没有停止的时候会执行 complete 回调  
                complete: function (res) {
                    VoiceLocalId = res.localId;
                    document.getElementById("btn_voice_record").innerText = "按住不放即可录音";

                    if (VoiceLocalId.length > 0) {
                        CanPlayVoice();
                        //上传音频
                        uploadVoice();
                    }

                }
            });
            //监听录音播放完毕接口
            wx.onVoicePlayEnd({
                success: function (res) {
                    document.getElementById("btn_voice_play").innerText = "播放录音";
                    $("#btn_voice_play").removeClass("mui-btn-warning");
                    $("#btn_voice_play").addClass("mui-btn-success");
                }
            }); 
        })

        //图片删除
        function remove_pic(obj) {
            $(obj).parent('li').remove();
            //重新修改全局变量里的
            var new_img_arr = [];
            $(".album-item").each(function () {
                new_img_arr.push($(this).find("img").attr("src"));
            });
            images.localIds = new_img_arr;
        }

        
        //1.拍照、本地选图
        function chooseImage() {
            if (images.localIds.length == 9) {
                alert('最多允许选中9张图片');
                return;
            }
            else {
                wx.chooseImage({
                    count: 9 - images.localIds.length, // 默认9
                    sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                    sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                    success: function (res) {
                        $(function () {
                            $.each(res.localIds, function (i, n) {
                                var html = "<li class='album-item'><img src='" + n + "' server-id='' /><i onclick=\"remove_pic(this)\"/></li>";
                                //在最后一个元素之前插入图片
                                $('.upload-album > li:last-child').before(html);
                                images.localIds.push(n);

                            });
                            //alert(res.localIds.join())
                            uploadImages();
                        });
                    },
                    cancel: function () {
                        //alert("已取消选择");
                    }
                });
            }
        }

        //2.上传图片
        var i = 0, length = 0;
        function uploadImages() {
            length = images.localIds.length;
            if (length > 0) {
                upload();
            }
        }

        function uploadVoice() {
            if (VoiceLocalId.length == 0) {
                return;
            }
            //上传语音接口  
            wx.uploadVoice({
                localId: VoiceLocalId,
                isShowProgressTips: 1,
                success: function (res) {
                    //返回音频的服务器端ID  
                    VoiceServerId = res.serverId;
                }
            }); 
        }


        //递归调用的方法
        function upload() {
            wx.uploadImage({
                localId: images.localIds[i],
                isShowProgressTips: 1,
                success: function (res) {                    
                    console.log('已上传：' + i + '/' + length);
                    images.serverIds.push(res.serverId);
                    //完成后把服务器ID放到图片的属性中
                    $(".album-item").each(function () {
                        if ($(this).find("img").attr("src") == images.localIds[i]) {
                            $(this).find("img").attr("server-id", res.serverId)
                        }
                    });
                    
                    i++;
                    if (i < length) {
                        upload();
                    }
                },
                fail: function (res) {
                    //alert(JSON.stringify(res));
                    alert(images.localIds[i]);
                }
            });
        }


         

        //可以播放录音
        function CanPlayVoice() {
            $(".upload-voice-play").show();
        }

        wx.error(function (res) {
            alert(res.errMsg);
        });

    </script>

}
<!-- MUI 页面底部脚本 END -->
