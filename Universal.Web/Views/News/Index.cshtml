@model Universal.Web.Models.NewsIndex
@{
    Layout = null;
}

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>医学通识</title>
    <link href="~/Assets/mui/css/mui.min.css" rel="stylesheet" />
    <link href="~/Assets/mui/css/mui.ext.loading.css" rel="stylesheet" />
    <style>
        .mui-content { background-color: #FFFFFF !important; }

        body { background-color: #FFFFFF !important; }

        .mui-slider-title { background-color: rgba(0, 0, 0, 0.7) !important; color: #FFF; }
        h1, h2, h3, h4, h5, h6 { margin: 0; padding: 0; font-size: 14px; }

        ul, ol { margin: 0; padding: 5px 5px 5px 40px; }

        dl, p { margin: 0; padding: 0; }

        a { background: 0 0 }
        a:link { color: #000; }
        a:visited { color: #000; }
        a:hover { color: #000; }
        a:link { color: #000; }
        a:active { background-color: #F0F0F0; }

        ul { margin: 0; padding: 0; }

        ul, li { list-style: none; margin: 0; padding: 0; }
        .wrap { width: 100%; max-width: 1200px; margin: 0 auto; float: left; }

        .nav ul li { background: #f6f6f6; float: left; text-align: center; font-size: 1em; height: 35px; width: 25%; border: 1px solid #fff; box-sizing: border-box; }

            .nav ul li.on { background-color: #006d83; }

                .nav ul li.on a { color: #FFFFFF; }

            .nav ul li a { display: inline-block; line-height: 35px; padding: 0 0.3em; }

        .drop a { color: #006d83; display: inline-block; margin-bottom: 0.5em; padding: 0 0.5em; border-right: 1px solid #006d83; }
            .drop a:last-child { border-right: 0; }
        .drop ul li { display: list-item; }
        .mainer { padding-bottom: 2em; }
        .new_list { margin: 0 auto; margin-top: 2em; }
        .flt { float: left; }
        .new_list li { height: 4.2em; margin-bottom: 1em; }
        .new_list .img { width: 30%; max-width: 315px; padding-left: 5px; }
        .new_list .text { width: 70%; float: right; padding: 5px 5px 0 10px; }
        .new_list img { width: 100%; }
        .new_list li h2 { font-size: 0.9em; border-bottom: 0; padding-bottom: 0.2em; font-weight: normal; }
        .new_list li a { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis }
        .new_list li p { margin-top: 5px;; height: 3em; color: #9c9c9c; overflow: hidden; white-space: pre-wrap; text-overflow: ellipsis; }
        .load_more { width: 100%; text-align: center; height: 2em; line-height: 2em; }
    </style>
</head>

<body>

    <div class="mui-content">

        @{
            var banner_total = Model.banner_list.Count;
            var frist_banner = Model.banner_list.FirstOrDefault();
            var last_banner = Model.banner_list.LastOrDefault();
            var default_category_id = 0;
        }
        @if (banner_total > 0)
        {

            <div id="slider" class="mui-slider">
                <div class="mui-slider-group mui-slider-loop">
                    <!--
                        作者：litdev@outlook.com
                        时间：2018-03-24
                        描述：图片顺序为：4、1、2、3、4、1
                    -->
                    <!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->

                    <div class="mui-slider-item mui-slider-item-duplicate">
                        <a @if (last_banner.LinkType == Universal.Entity.MedicalBannerLinkType.Medical) { @: href="Detail?id=@last_banner.LinkVal"
                           } else { @: href="@last_banner.LinkVal" target="_blank"
                           }>
                            <img src="@last_banner.ImgUrl.Replace("_thumb","")">
                            <p class="mui-slider-title">@last_banner.Title</p>
                        </a>
                    </div>
                    @foreach (var item in Model.banner_list)
                    {
                        <div class="mui-slider-item">
                            <a @if (item.LinkType == Universal.Entity.MedicalBannerLinkType.Medical) { @: href="Detail?id=@item.LinkVal"
                               } else { @: href="@item.LinkVal" target="_blank"
                               }>
                                <img src="@item.ImgUrl.Replace("_thumb","")">
                                <p class="mui-slider-title">@item.Title</p>
                            </a>
                        </div>
                    }

                    <!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
                    <div class="mui-slider-item mui-slider-item-duplicate">
                        <a @if (frist_banner.LinkType == Universal.Entity.MedicalBannerLinkType.Medical) { @: href="Detail?id=@frist_banner.LinkVal"
                           } else { @: href="@frist_banner.LinkVal" target="_blank"
                           }>
                            <img src="@frist_banner.ImgUrl.Replace("_thumb","")">
                            <p class="mui-slider-title">@frist_banner.Title</p>
                        </a>
                    </div>
                </div>
                <div class="mui-slider-indicator mui-text-right">
                    @for (int i = 1; i <= banner_total; i++)
                    {
                        if (i == 1)
                        {
                            @:<div class="mui-indicator mui-active"></div>
                        }
                        else
                        {
                            @:<div class="mui-indicator"></div>
                        }
                    }

                </div>
            </div>

        }

        @if (Model.category_list.Count > 0)
        {
            <div class="nav_list">
                <div class="nav">
                    <div class="wrap">
                        <ul>
                            @{ int i = 0;}
                            @foreach (var item in Model.category_list)
                            {
                                <li data-id="@item.category_id"
                                    @if (i == 0) { default_category_id = item.category_id; @: class="category_li on"
                                    } else { @: class="category_li"
                                    }
                                    @{ i++;}>
                                    <a href="javascript:;" onclick="ChangeTags(@item.category_id)">@item.category_title</a>
                                </li>

                            }
                        </ul>
                    </div>
                </div>

                <div class="drop">
                    <div class="wrap" style="margin-top:10px;">
                        <ul>
                            @{ int ii = 0;}
                            @foreach (var item in Model.category_list)
                            {
                                <li data-cid="@item.category_id" class="category_tag_li"
                                    @if (ii != 0) { @: style="display:none;"
                                    }>
                                    @{ ii++;}
                                    <p>
                                        @foreach (var tag in item.tag_list)
                                        {
                                            <a href="javascript:;" onclick="ByTag(@tag.tag_id)">@tag.tag_title</a>
                                        }
                                    </p>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>

        }


        <div class="mainer">
            <div class="wrap">
                <div class="new_list">
                    <ul id="news_ul">
                    <script type="text/html" id="template_news_list">
                        {{each data}}
                        <li>
                            <div class="img flt"><img src="{{$value.img_url}}"></div>
                            <div class="text">
                                <h2><a href="Detail?id={{$value.id}}">{{$value.title}}</a></h2>
                                <p>{{$value.summer}}</p>
                            </div>
                        </li>
                        {{/each}}
                    </script>
                    </ul>
                </div>
                <div class="load_more">
                    加载更多
                </div>
            </div>
        </div>
    </div>

    <script src="~/Assets/mui/js/jquery.min.js"></script>
    <script src="~/Assets/mui/js/mui.min.js"></script>
    <script src="~/Assets/mui/js/mui.ext.loading.js"></script>
    <script src="~/Assets/mui/js/template-web.js"></script>
    <script type="text/javascript" charset="utf-8">
        var category_id = @default_category_id;
        var page_size = 8;
        var curr_page = 0;
        var tag_id = 0;
        (function ($$) {
            $$.init({
                swipeBack: true //启用右滑关闭功能
            });
            var slider = $$("#slider").slider({
                interval: 5000
            });

        })(mui);

        $(function () {
            //第一次加载
            LoadAjaxData(true);
        })
        function LoadAjaxData(isClear) {
            if (isClear) {
                curr_page = 1;
            } else {
                curr_page = curr_page + 1;
            }
            $.ajax({
                type: "post",
                url: "/News/LoadNews",
                data: { "page": curr_page, "size": page_size, "cid": category_id, "tid": tag_id },
                async: false,
                dataType: 'json',
                beforeSend: function () {
                    mui.showLoading("加载中..", "div");
                },
                complete: function () {
                    mui.hideLoading();
                },
                success: function (res) {
                    if (res.msg == 1) {
                        var html = template('template_news_list', res);
                        if (isClear) {
                            $("#news_ul").html(html);
                        }
                        else {
                            $("#news_ul").append(html);
                        }

                        if (res.data.length < page_size) {
                            DataIsNull("没有更多数据了");
                        } else {
                            DataIsNotNull("点击加载更多");
                        }
                    }
                    else {
                        mui.toast(res.msgbox);
                    }
                },
                error: function () {
                    mui.toast('获取数据失败，请检查网络连接');
                }
            })

        }

        //没有数据
        function DataIsNull(text) {
            $(".load_more").show();
            $(".load_more").html(text);
            $(".load_more").unbind('click', LoadMore);
        }
        //可以继续加载
        function DataIsNotNull(text) {
            $(".load_more").show();
            $(".load_more").html(text);
            $(".load_more").bind('click', LoadMore);
        }

        function LoadMore() {
            LoadAjaxData(false);
        }

        function trimString(str, maxLength) {
            if (str.length > maxLength) {
                str = str.substr(0, maxLength) + '...';
            }
            return str;
        }

        function ChangeTags(cid) {
            $(".category_li").each(function (i, ele) {
                if ($(this).attr("data-id") == cid) {
                    $(this).addClass("on");
                } else {
                    $(this).removeClass("on");
                }
                
            })
            $(".category_tag_li").each(function (i, ele) {
                if ($(this).attr("data-cid") == cid) {
                    $(this).css("display", "block");
                } else {
                    $(this).css("display", "none");
                }
            });
            category_id = cid;
            tag_id = 0;
            LoadAjaxData(true);
        }
        function ByTag(tid) {
            tag_id = tid;
            LoadAjaxData(true);
        }

    </script>

</body>
</html>